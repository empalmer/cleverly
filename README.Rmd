---
output: github_document
---

<!-- README.md is generated from README.Rmd. Please edit that file -->

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.path = "man/figures/README-",
  out.width = "100%"
)
```

# cleverly

<!-- badges: start -->
<!-- badges: end -->

Cleverly stands for (Cl)ustering with (E)xternal (V)ariabl(e)s in (R) with (L)ongitudinal (Y)s. 


# Installation

You can install the development version of cleverly from [GitHub](https://github.com/) with:

```{r load package, echo = T, results = 'hide', message = F, warning = F}
# install.packages("pak")
pak::pak("empalmer/cleverly")
library(cleverly)
```

# Example usage: 
## Simulate example data (binary)

Simulate compositional count data with longitudinal independence structure. This code will simulate 20 samples across 12 responses, using a binary external variable. Default arguments to \code{simulation_data} simulate 3 baseline clusters with 4 members each. 

```{r sim_data}
set.seed(127)
sim <- simulation_data(n = 20,
                       K = 12,
                       user_var = 1000,
                       cor_str = "IND", 
                       Z_type = "binary")

Y <- sim$Y
Z <- sim$Z

true_cluster <- rep(1:3, each = 4)

head(Y)
head(Z)
```

$Y$ is a data frame of 12 counts with a column of time and a column of individual. Z is a vector of binary external variables. 


## Run algorithm: 

We now run the 'cleverly' algorithm, specifying the commonly needed arguments. Here, we specify subject_ids = individual, as individual is the id column in Y. We could have alternately given a vector of IDs. Similarly for time. \code{cleverly} needs to select the ideal tuning parameter psi - so we give a range of psi_min to psi_max, and a number to test (6). 

We set \code{cluster_index} to 0 because we want to cluster on the baseline values, ie when $Z = 0$. If we want to cluster on the slope value, ie the effect of $Z$, we would set cluster_index to 1. 

```{r run algorithm, cache = T}
res <- cleverly(Y = Y,
                Z = Z,
                subject_ids = individual,
                time = time,
                cluster_index = 0,
                cor_str = "IND",
                psi_min = 10,
                psi_max = 5000,
                npsi = 3) 
```

## Results

```{r}
names(res)
```



## Diagnostics: 

Since we know the true clusters: 


```{r}
get_cluster_diagnostics(res, true_cluster)$cluster_diagnostics
```

We selected the exact right clusters!

## Visualizations

Visualize the data + clusters 

```{r}
plot_clusters(res)
```

Alternatively, if we want to examine a single cluster: 

```{r}
plot_one_cluster(res, cluster_val = 1)
```


## Simulate example data (continuous, slope)


## Troubleshooting: 

### Poorly fit data

```{r, cache = T}
res <- cleverly(Y = Y,
                Z = Z,
                subject_ids = individual,
                time = time,
                cluster_index = 0,
                cor_str = "IND",
                gammas = c(1e4, 1e4),
                psi_min = 500,
                npsi = 1) 

plot_clusters(res)
```

The tuning parameter `gammas` can be specified, but it is usually fine to leave it at the default. If you see the overall fit seems bad (in this case underfit, because gamma is too large), it can be changed.

### Too small hyper parameter range

```{r}
res <- cleverly(Y = Y,
                Z = Z,
                subject_ids = individual,
                time = time,
                cluster_index = 0,
                cor_str = "IND",
                psi_min = 10,
                psi_max = 11,
                npsi = 3) 
```

We get a warning, increase the range between psi_min and psi_max, or increase npsi. 
# Algorithm details
